<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Time and Work Test</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{background:#000;color:#fff;font-family:Segoe UI;margin:0;}
.container{max-width:1000px;margin:auto;padding:20px;}
.start-center{display:flex;justify-content:center;align-items:center;height:100vh;text-align:center;}
input{padding:12px;border-radius:6px;border:none;margin-top:10px;width:260px;font-size:16px;}
.card{background:#141414;padding:25px;margin-top:20px;border-radius:12px;}
button{padding:12px 18px;background:#00bfff;border:none;color:#fff;border-radius:6px;margin-top:15px;cursor:pointer;font-size:16px;}
.navigation{display:flex;justify-content:space-between;margin-top:20px;}
#proctorBox{position:fixed;top:15px;right:15px;z-index:2000;text-align:center;}
#webcam{width:200px;border-radius:10px;border:2px solid #00bfff;}
#proctorWarning{color:red;font-size:13px;margin-top:5px;}

/* PDF Styles */
#resultWrapper{display:flex;justify-content:center;background:#000;padding:40px 0;}
#resultBox{
  width:190mm;
  min-height:210mm;
  padding:20mm;
  box-sizing:border-box;
  background:#000;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
}
#resultBox h2{text-align:center;margin-bottom:15px;}
.chart-wrapper{width:100%;display:flex;justify-content:space-evenly;margin-top:25px;}
.chart-box{width:160px;height:160px;}
.signature{width:100%;display:flex;justify-content:space-between;margin-top:50px;padding:0 30px;}
.watermark{width:100%;margin-top:50px;border-top:1px solid #444;padding-top:15px;font-size:13px;opacity:0.6;text-align:center;}
@media print{button{display:none!important;}}
.option-label{display:block;background:#1e1e1e;padding:10px;margin:10px 0;border-radius:6px;}
.number-panel{display:flex;flex-wrap:wrap;margin-top:20px;}
.number-box{width:40px;height:40px;margin:3px;background:#222;border-radius:5px;text-align:center;line-height:40px;font-weight:bold;cursor:pointer;}
.number-box.active{border:2px solid #00bfff;}
.number-box.answered{background:#00aa55;}
</style>
</head>

<body>

<div id="startPage" class="start-center">
  <div>
    <h1>⏱️ Time and Work Test</h1>
    <input type="text" id="name" placeholder="Enter Student Name"><br>
    <input type="text" id="rollno" placeholder="Enter Roll Number"><br>
    <button onclick="startTest()">Start Test</button>
  </div>
</div>

<div class="container">
<div id="timer" style="text-align:center;margin-top:10px;"></div>
<div id="numberPanel" class="number-panel" style="display:none;"></div>
<div id="questions"></div>
<div class="navigation" id="navButtons" style="display:none;">
  <button onclick="previousQuestion()">Previous</button>
  <button onclick="nextQuestion()">Next</button>
</div>
<div style="text-align:center;">
  <button id="submitBtn" style="display:none;" onclick="submitTest()">Submit Test</button>
</div>
<div id="dashboard"></div>
</div>

<!-- Webcam -->
<div id="proctorBox" style="display:none;">
  <video id="webcam" autoplay playsinline></video>
  <canvas id="motionCanvas" style="display:none;"></canvas>
  <div id="proctorWarning"></div>
</div>

<script>
// ------------------ Supabase ------------------
const supabaseUrl = 'https://yqfhvvjsybbjwldjsjga.supabase.co';
const supabaseKey = 'sb_publishable_hK0s7eE3P1ILoADp-VQ7JQ_FVE5_ixT';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// ------------------ Variables ------------------
let questions=[],userAnswers=[],currentIndex=0,timeLeft=0,timerInterval=null;
let studentName="",rollNumber="",stream=null,previousFrame=null,motionInterval=null,violationCount=0;
let testActive=false;

// ------------------ Start Test ------------------
async function startTest(){
  studentName=document.getElementById("name").value.trim();
  rollNumber=document.getElementById("rollno").value.trim();
  if(studentName===""){alert("Enter Name");return;}
  if(!/^[0-9]{3}[a-zA-Z]{2}[0-9]{3}$/.test(rollNumber)){alert("Enter Valid Roll Number");return;}

  const { data,error } = await supabaseClient.from('timeandworkquestions').select('*');
  if(error || !data.length){alert("Failed to load questions"); return;}
  questions=data;
  userAnswers=new Array(questions.length).fill(null);

  document.getElementById("startPage").style.display="none";
  document.getElementById("navButtons").style.display="flex";
  document.getElementById("numberPanel").style.display="flex";
  document.getElementById("submitBtn").style.display="inline-block";

  generateNumberPanel();
  renderQuestion();
  timeLeft=questions.length*30;
  testActive=true;
  startTimer();
  startWebcam();
}

// ------------------ Tab Switch Detection ------------------
document.addEventListener("visibilitychange", function() {
  if (document.hidden && testActive) { alert("Tab Changed! Test Auto Submitted."); submitTest(); }
});

// ------------------ Question Rendering ------------------
function renderQuestion(){
  let q=questions[currentIndex];
  document.getElementById("questions").innerHTML=`<div class="card">
    <p><b>Q${currentIndex+1} of ${questions.length}</b></p>
    <p>${q.question}</p>
    ${createOption(q.option1,"Option1")}
    ${createOption(q.option2,"Option2")}
    ${createOption(q.option3,"Option3")}
    ${createOption(q.option4,"Option4")}
  </div>`;
  updateNumberPanel();
}

function createOption(text,value){
  let checked=userAnswers[currentIndex]===value?"checked":"";  
  return `<label class="option-label">
    <input type="radio" ${checked} onchange="userAnswers[${currentIndex}]='${value}'"> ${text}
  </label>`;
}

function nextQuestion(){ if(currentIndex<questions.length-1){currentIndex++;renderQuestion();} }
function previousQuestion(){ if(currentIndex>0){currentIndex--;renderQuestion();} }

// ------------------ Number Panel ------------------
function generateNumberPanel(){
  const panel=document.getElementById("numberPanel");
  panel.innerHTML="";
  for(let i=0;i<questions.length;i++){
    const box=document.createElement("div");
    box.className="number-box";
    box.innerText=i+1;
    box.onclick=()=>{currentIndex=i;renderQuestion();};
    panel.appendChild(box);
  }
  updateNumberPanel();
}
function updateNumberPanel(){
  const boxes=document.getElementById("numberPanel").children;
  for(let i=0;i<boxes.length;i++){
    boxes[i].classList.remove("active","answered");
    if(i===currentIndex) boxes[i].classList.add("active");
    if(userAnswers[i]) boxes[i].classList.add("answered");
  }
}

// ------------------ Timer ------------------
function startTimer(){
  timerInterval=setInterval(()=>{
    timeLeft--;
    let m=Math.floor(timeLeft/60),s=timeLeft%60;
    if(s<10)s="0"+s;
    document.getElementById("timer").innerText="⏳ Time Left: "+m+":"+s;
    if(timeLeft<=0) submitTest();
  },1000);
}

// ------------------ Webcam ------------------
async function startWebcam(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:true});
    const video=document.getElementById("webcam");
    video.srcObject=stream;
    await video.play();
    document.getElementById("proctorBox").style.display="block";
    startMotionDetection();
  }catch(e){alert("Camera access required");}
}
function stopWebcam(){ if(stream){stream.getTracks().forEach(t=>t.stop());} clearInterval(motionInterval); }

// ------------------ Motion Detection ------------------
function startMotionDetection(){
  const video=document.getElementById("webcam");
  const canvas=document.getElementById("motionCanvas");
  const ctx=canvas.getContext("2d");
  motionInterval=setInterval(()=>{
    if(video.readyState!==4) return;
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
    if(previousFrame){
      let diff=0;
      for(let i=0;i<frame.data.length;i+=4){ diff+=Math.abs(frame.data[i]-previousFrame.data[i]); }
      let avg=diff/(frame.data.length/4);
      if(avg>25){ violationCount++; document.getElementById("proctorWarning").innerText="⚠ Movement Detected ("+violationCount+")"; if(violationCount>=5){ alert("Too much movement, auto submitting."); submitTest(); } }
    }
    previousFrame=frame;
  },1000);
}

// ------------------ Submit Test ------------------
function submitTest(){
  testActive=false;
  clearInterval(timerInterval); stopWebcam();

  let correct=0; questions.forEach((q,i)=>{ if(userAnswers[i]===q.correctoption) correct++; });
  let wrong=questions.length-correct;
  let percentage=Math.round((correct/questions.length)*100);
  let grade=percentage>=85?"Excellent":percentage>=65?"Good":percentage>=40?"Average":"Poor";

  document.getElementById("questions").innerHTML="";
  document.getElementById("navButtons").style.display="none";
  document.getElementById("submitBtn").style.display="none";
  document.getElementById("timer").innerHTML="";

  document.getElementById("dashboard").innerHTML=`
  <div id="resultWrapper">
  <div id="resultBox">
  <h2>Time and Work Exam Result</h2>
  <p><b>Name:</b> ${studentName}</p>
  <p><b>Roll No:</b> ${rollNumber}</p>
  <p><b>Total Questions:</b> ${questions.length}</p>
  <p><b>Correct:</b> ${correct}</p>
  <p><b>Wrong:</b> ${wrong}</p>
  <p><b>Percentage:</b> ${percentage}%</p>
  <p><b>Grade:</b> ${grade}</p>

  <div class="chart-wrapper">
    <div class="chart-box"><canvas id="pieChart"></canvas></div>
    <div class="chart-box"><canvas id="barChart"></canvas></div>
  </div>

  <div class="signature">
    <div>_____________________<br>Student Signature</div>
    <div>_____________________<br>Examiner Signature</div>
  </div>

  <div class="watermark">
    Generated by Cognitive Analytics Engine for Aptitude Evaluation
  </div>

  <br><br>
  <button onclick="downloadPDF()">Download Result</button>
  </div></div>
  `;
  generateCharts(correct,wrong);
}

// ------------------ Charts ------------------
function generateCharts(correct,wrong){
  new Chart(document.getElementById("pieChart"),{
    type:'pie',
    data:{labels:['Correct','Wrong'],datasets:[{data:[correct,wrong],backgroundColor:['#00ff99','#ff4444']}]}
  });
  new Chart(document.getElementById("barChart"),{
    type:'bar',
    data:{labels:['Correct','Wrong'],datasets:[{data:[correct,wrong],backgroundColor:['#00ff99','#ff4444']}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

// ------------------ PDF ------------------
function downloadPDF(){
  const element=document.getElementById("resultBox");
  html2pdf().set({
    margin:[5,5,5,5],
    filename: studentName+"_Time_and_Work_Result.pdf",
    image:{type:'jpeg',quality:1},
    html2canvas:{scale:3,useCORS:true,scrollY:0,backgroundColor:"#000"},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  }).from(element).save();
}
</script>
</body>
</html>