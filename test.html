<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Unified Aptitude Test</title>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{background:#000;color:#fff;font-family:Segoe UI;margin:0;}
.no-select{user-select:none;}
.container{max-width:1000px;margin:auto;padding:20px;}
.start-center{display:flex;justify-content:center;align-items:center;height:100vh;text-align:center;}
input{padding:12px;border-radius:6px;border:none;margin-top:10px;width:260px;font-size:16px;}
.card{background:#141414;padding:25px;margin-top:20px;border-radius:12px;}
button{padding:12px 18px;background:#00bfff;border:none;color:#fff;border-radius:6px;margin-top:15px;cursor:pointer;font-size:16px;}
button:disabled{background:#555;}
#timer{font-size:20px;color:#00ff99;text-align:center;margin-top:15px;}
.number-panel{display:flex;overflow-x:auto;gap:8px;padding:10px 0;margin-top:20px;border-bottom:1px solid #333;position:sticky;top:0;background:#000;z-index:1000;scroll-behavior:smooth;}
.number-box{min-width:42px;height:42px;display:flex;align-items:center;justify-content:center;background:#222;border-radius:6px;cursor:pointer;font-weight:bold;flex-shrink:0;}
.number-box.active{border:2px solid #00bfff;}
.number-box.answered{background:#00aa55;color:#fff;}
.navigation{display:flex;justify-content:space-between;margin-top:20px;}
.submit-section{text-align:center;margin-top:30px;}
.dashboard{background:#000;padding:40px;text-align:center;min-height:1120px;}
#resultBox{width:200mm;min-height:270mm;margin:auto;padding:25mm 20mm;box-sizing:border-box;background:#000;color:#fff;text-align:center;}
.chart-container{width:260px;height:260px;margin:20px auto;}
.option-label{display:block;background:#1e1e1e;padding:12px;margin:12px 0;border-radius:8px;cursor:pointer;}
.watermark{margin-top:60px;padding-top:30px;border-top:1px solid #333;font-size:15px;opacity:0.9;}
.watermark strong{display:block;margin-top:8px;font-size:17px;}
#proctorBox{position:fixed;top:15px;right:15px;z-index:2000;text-align:center;}
#webcam{width:200px;border-radius:10px;border:2px solid #00bfff;}
#proctorWarning{color:red;font-size:13px;margin-top:5px;}
.test-card {background:#141414;color:#fff;padding:25px 40px;border-radius:12px;cursor:pointer;font-size:18px;font-weight:bold;transition:0.2s all;border:2px solid #222;}
.test-card.selected {border-color:#00bfff;background:#1e1e1e;transform:scale(1.05);}
.test-card:hover {transform:scale(1.05);border-color:#00bfff;}
@media print{button{display:none!important;}}
</style>
</head>
<body>

<!-- START PAGE -->
<div id="startPage" class="start-center">
  <div>
    <h1>üß† Aptitude Test</h1>
    <input type="text" id="name" placeholder="Enter Student Name"><br>
    <input type="text" id="rollno" placeholder="Enter Roll Number"><br>

    <h2>üìù Select a Test</h2>
    <div class="test-cards" style="display:flex;justify-content:center;gap:20px;margin-top:20px;">
      <div class="test-card" data-value="problemsolvingquestions" onclick="selectTest(this)">üß† Problem Solving</div>
      <div class="test-card" data-value="logicalreasoningquestions" onclick="selectTest(this)">üîç Logical Reasoning</div>
      <div class="test-card" data-value="timeandworkquestions" onclick="selectTest(this)">‚è±Ô∏è Time & Work</div>
    </div>

    <button style="margin-top:30px;" onclick="startTest()">Start Test</button>
  </div>
</div>

<!-- TEST CONTAINER -->
<div class="container">
  <div id="timer"></div>
  <div id="numberPanel" class="number-panel" style="display:none;"></div>
  <div id="questions"></div>

  <div id="navigation" class="navigation" style="display:none;">
    <button id="prevBtn" onclick="previousQuestion()">Previous</button>
    <button id="nextBtn" onclick="nextQuestion()">Next</button>
  </div>

  <div id="submitSection" class="submit-section" style="display:none;">
    <button onclick="submitTest()">Submit Test</button>
  </div>

  <div id="dashboard"></div>
</div>

<!-- WEBCAM PROCTOR -->
<div id="proctorBox" style="display:none;">
  <video id="webcam" autoplay playsinline></video>
  <div id="proctorWarning"></div>
</div>

<script>
const supabaseUrl='https://yqfhvvjsybbjwldjsjga.supabase.co';
const supabaseKey='sb_publishable_hK0s7eE3P1ILoADp-VQ7JQ_FVE5_ixT';
const supabaseClient=supabase.createClient(supabaseUrl,supabaseKey);

let selectedTest="", questions=[], userAnswers=[], currentIndex=0, timeLeft=0, timerInterval=null;
let studentName="", rollNumber="", stream=null, previousFrame=null, motionInterval=null, violationCount=0;
let resultChart=null, testActive=false;

// ------------------ TEST SELECTION ------------------
function selectTest(card){
  document.querySelectorAll('.test-card').forEach(c=>c.classList.remove('selected'));
  card.classList.add('selected');
  selectedTest = card.dataset.value;
}

// ------------------ START TEST ------------------
async function startTest(){
  studentName = document.getElementById("name").value.trim();
  rollNumber = document.getElementById("rollno").value.trim();
  if(!studentName){alert("Enter Name"); return;}
  if(!rollNumber){alert("Enter Roll Number"); return;}
  if(!selectedTest){alert("Select a Test"); return;}

  document.body.classList.add("no-select");
  document.getElementById("startPage").style.display = "none";

  const { data, error } = await supabaseClient.from(selectedTest).select('*');
  if(error || !data){alert("Failed to load questions"); return;}
  questions = data;
  userAnswers = new Array(questions.length).fill(null);
  currentIndex = 0;
  timeLeft = questions.length * 30;
  testActive = true;

  document.getElementById("navigation").style.display = "flex";
  document.getElementById("numberPanel").style.display = "flex";
  document.getElementById("submitSection").style.display = "block";

  generateNumberPanel();
  renderQuestion();
  startTimer();
  await startWebcam();
}

// ------------------ QUESTION PANEL ------------------
function renderQuestion(){
  let q = questions[currentIndex];
  document.getElementById("questions").innerHTML = `<div class="card">
    <p><b>Q${currentIndex+1} of ${questions.length}:</b> ${q.question}</p>
    ${createOption(q.option1,"Option1")}
    ${createOption(q.option2,"Option2")}
    ${createOption(q.option3,"Option3")}
    ${createOption(q.option4,"Option4")}
  </div>`;
  updateButtons();
  updateNumberPanel();
}

function createOption(text,value){
  let checked = userAnswers[currentIndex]===value ? "checked" : "";
  return `<label class="option-label">
    <input type="radio" name="question${currentIndex}" value="${value}" ${checked} onchange="saveAnswer('${value}')">
    ${text}
  </label>`;
}

function saveAnswer(value){userAnswers[currentIndex]=value; updateNumberPanel();}
function nextQuestion(){if(currentIndex<questions.length-1){currentIndex++; renderQuestion();}}
function previousQuestion(){if(currentIndex>0){currentIndex--; renderQuestion();}}

function updateButtons(){
  document.getElementById("prevBtn").disabled=currentIndex===0;
  document.getElementById("nextBtn").disabled=currentIndex===questions.length-1;
}

function generateNumberPanel(){
  const panel = document.getElementById("numberPanel"); panel.innerHTML="";
  for(let i=0;i<questions.length;i++){
    const box = document.createElement("div");
    box.className="number-box"; box.innerText=i+1;
    box.onclick=()=>{currentIndex=i; renderQuestion();};
    panel.appendChild(box);
  }
  updateNumberPanel();
}

function updateNumberPanel(){
  const boxes=document.querySelectorAll(".number-box");
  boxes.forEach((box,i)=>{
    box.classList.remove("active","answered");
    if(i===currentIndex) box.classList.add("active");
    if(userAnswers[i]!==null) box.classList.add("answered");
  });
}

// ------------------ TIMER ------------------
function startTimer(){
  timerInterval=setInterval(()=>{
    timeLeft--; let m=Math.floor(timeLeft/60), s=timeLeft%60;
    if(s<10) s="0"+s;
    document.getElementById("timer").innerText="‚è≥ Time Left: "+m+":"+s;
    if(timeLeft<=0) submitTest();
  },1000);
}

// ------------------ WEBCAM PROCTOR ------------------
async function startWebcam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    const video=document.getElementById("webcam"); video.srcObject=stream; await video.play();
    document.getElementById("proctorBox").style.display="block";

    motionInterval=setInterval(()=>{
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0);
      const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
      if(previousFrame){
        let diff=0;
        for(let i=0;i<frame.data.length;i+=4){ diff+=Math.abs(frame.data[i]-previousFrame.data[i]); }
        let avg=diff/(frame.data.length/4);
        if(avg>25){violationCount++; document.getElementById("proctorWarning").innerText="‚ö† Movement Detected ("+violationCount+")"; if(violationCount>=5){alert("Too much movement, auto submitting."); submitTest();}}
      }
      previousFrame=frame;
    },1000);

  } catch(e){alert("Camera access required for proctoring.");}
}

function stopWebcam(){if(stream){stream.getTracks().forEach(t=>t.stop());} clearInterval(motionInterval);}

// ------------------ TAB CHANGE ------------------
document.addEventListener("visibilitychange", function(){if(document.hidden && testActive){alert("Tab changed! Auto-submitting."); submitTest();}});

// ------------------ SUBMIT ------------------
function submitTest(){
  testActive=false; clearInterval(timerInterval); stopWebcam();

  let correct=0; questions.forEach((q,i)=>{if(userAnswers[i]===q.correctoption) correct++;});
  let wrong=questions.length-correct;
  let percentage=Math.round((correct/questions.length)*100);
  let grade=percentage>=85?"Excellent":percentage>=65?"Good":percentage>=40?"Average":"Poor";

  document.getElementById("questions").innerHTML="";
  document.getElementById("navigation").style.display="none";
  document.getElementById("submitSection").style.display="none";
  document.getElementById("numberPanel").style.display="none";
  document.getElementById("timer").innerHTML="";

  document.getElementById("dashboard").innerHTML=`
    <div class="dashboard" id="resultBox">
      <h2>Test Result</h2>
      <p><b>Name:</b> ${studentName}</p>
      <p><b>Roll No:</b> ${rollNumber}</p>
      <p><b>Total Questions:</b> ${questions.length}</p>
      <p><b>Correct:</b> ${correct}</p>
      <p><b>Wrong:</b> ${wrong}</p>
      <p><b>Percentage:</b> ${percentage}%</p>
      <p><b>Grade:</b> ${grade}</p>

      <div class="chart-container"><canvas id="resultChart"></canvas></div>

      <div class="watermark">
        Generated by Cognitive Analytics Engine for Aptitude Evaluation
        <strong>Developed by - V.Akilan</strong>
      </div>
    </div>

    <button id="downloadBtn" onclick="downloadPDF()">Download PDF</button>
  `;

  createChart(correct,wrong);
}

// ------------------ CHART ------------------
function createChart(correct,wrong){
  const ctx=document.getElementById('resultChart').getContext('2d');
  if(resultChart) resultChart.destroy();
  resultChart=new Chart(ctx,{type:'pie',data:{labels:['Correct','Wrong'],datasets:[{data:[correct,wrong],backgroundColor:['#00ff99','#ff4444']}]}})
}

// ------------------ DOWNLOAD PDF ------------------
function downloadPDF(){
  const element=document.getElementById("resultBox");
  const button=document.getElementById("downloadBtn");
  button.style.display="none";

  html2pdf().set({
    margin:[5,5,5,5],
    filename: studentName+"_Result.pdf",
    image:{type:'jpeg',quality:1},
    html2canvas:{scale:3,useCORS:true,scrollY:0,backgroundColor:"#000"},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  }).from(element).save().then(()=>{button.style.display="inline-block";});
}
</script>

</body>
</html>